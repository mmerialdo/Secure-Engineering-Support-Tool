/* --------------------------------------------------------------------------------------------------------------------
// Copyright file="VulnerabilityModelManagerInput.java"
//  © Copyright European Space Agency, 2018-2020
//
//  Author: Software developed by RHEA System S.A.
// 
//  This file is subject to the terms and conditions defined in file 'LICENSE.txt', which is part of this source code package. 
//  No part of the package, including this file, may be copied, modified, propagated, or distributed 
//  except according to the terms contained in the file ‘LICENSE.txt’.
// --------------------------------------------------------------------------------------------------------------------
*/

package org.crmf.core.vulnerabilitymodel.manager;

import org.crmf.model.riskassessment.AssessmentProcedure;
import org.crmf.model.riskassessmentelements.Vulnerability;
import org.crmf.model.utility.GenericFilter;
import org.crmf.model.utility.GenericFilterEnum;
import org.crmf.model.utility.ModelObject;
import org.crmf.model.utility.TaxonomyReferenceBuilder;
import org.crmf.persistency.mapper.general.SestObjServiceInterface;
import org.crmf.persistency.mapper.project.AssprocedureServiceInterface;
import org.crmf.persistency.mapper.vulnerability.VulnerabilityServiceInterface;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Service;

import java.util.List;

//This class is called by the Proxy and manages the entrypoint for the business logic (including the interactions with the Persistency) related to the VulnerabilityModel
@Service
public class VulnerabilityModelManagerInput {
  // the logger of VulnerabilityModelManagerInput class
  private static final Logger LOG = LoggerFactory.getLogger(VulnerabilityModelManagerInput.class.getName());
  // Vulnerability service variable of persistency component
  @Autowired
  @Qualifier("default")
  private VulnerabilityServiceInterface vulnerabilityService;
  // Procedure service variable of persistency component
  @Autowired
  @Qualifier("default")
  private AssprocedureServiceInterface assprocedureService;
  @Autowired
  @Qualifier("default")
  private SestObjServiceInterface sestObjService;
  @Autowired
  private TaxonomyReferenceBuilder taxonomyReferenceBuilder;

  public void editVulnerabilityModel(String vulnerabilityModelJson, String vulnerabilityModelIdentifier) {
    // updateQuestionnaireJSON the json vulnerability model whose identifier is the vulnerability model identifier in input
    vulnerabilityService.update(vulnerabilityModelJson, vulnerabilityModelIdentifier);
  }

  public ModelObject loadVulnerabilityModel(GenericFilter filter) throws Exception {
    // get the procedure identifier passed in input
    String procedureIdentifier = filter.getFilterValue(GenericFilterEnum.PROCEDURE);
    LOG.info("loadVulnerabilityModel:: input procedure filter = {} ", procedureIdentifier);

    // if the value of procedure identifier is not null
    if (procedureIdentifier != null) {
      // retrieve the assessment procedure associated to the procedure identifier in input
      AssessmentProcedure procedure = assprocedureService.getByIdentifierFull(procedureIdentifier);

      //retrieve the vulnerability model identifier associated to the retrieved assessment procedure
      String sestobjId = procedure.getVulnerabilityModel().getIdentifier();

      // return the json vulnerability model associated to the vulnerability model identifier retrieved
      ModelObject modelObject = new ModelObject();
      modelObject.setJsonModel(vulnerabilityService.getByIdentifier(sestobjId).getVulnerabilityModelJson());
      modelObject.setObjectIdentifier(sestobjId);
      modelObject.setLockedBy(sestObjService.getByIdentifier(sestobjId).getLockedBy());
      return modelObject;
    } else {
      LOG.error("loadVulnerabilityModel:: Incorrect procedure identifier in input");
      throw new Exception("Incorrect procedure identifier in input");
    }
  }

  public String loadVulnerabilityRepository(GenericFilter filter) {
    // This method load all vulnerabilities saved in the database, for a given Catalogue (MEHARI, CWE, etc..)
    String catalogue = filter.getFilterValue(GenericFilterEnum.METHODOLOGY);
    LOG.info("loadVulnerabilityRepository {} ", filter.getFilterValue(GenericFilterEnum.METHODOLOGY));

    return vulnerabilityService.getVulnerabilityRepository(catalogue).getVulnerabilityModelJson();
  }

  public String createVulnerability(Vulnerability vulnerability) throws Exception {
    Vulnerability vulnerabilityChecked = taxonomyReferenceBuilder.vulnerabilityCheckAndFill(vulnerability);
    return vulnerabilityService.insertVulnerabilityReference(vulnerabilityChecked);
  }

  public void editVulnerability(Vulnerability vulnerability) throws Exception {
    Vulnerability vulnerabilityChecked = taxonomyReferenceBuilder.vulnerabilityCheckAndFill(vulnerability);
    vulnerabilityService.editVulnerabilityReference(vulnerabilityChecked);
  }

  public void deleteVulnerability(List<String> identifier) throws Exception {
    vulnerabilityService.deleteVulnerabilityReference(identifier);
  }
}
