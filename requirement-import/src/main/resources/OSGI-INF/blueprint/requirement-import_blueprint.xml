<?xml version="1.0" encoding="UTF-8"?>
<!-- This blueprint describes the needed dependencies for the sest-requirement-import bundle and the exposed interfaces, including the webservices -->
<blueprint xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xmlns:camel="http://camel.apache.org/schema/blueprint" xmlns:cxf="http://cxf.apache.org/blueprint/core"
           xmlns:cxfrs="http://camel.apache.org/schema/blueprint/cxf"
           xmlns:jaxrs="http://cxf.apache.org/blueprint/jaxrs"
           xmlns:beans="http://cxf.apache.org/configuration/beans"
           xsi:schemaLocation="
		  http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
		  http://www.osgi.org/xmlns/blueprint-ext/v1.1.0 https://svn.apache.org/repos/asf/aries/tags/blueprint-0.4.1/blueprint-core/src/main/resources/org/apache/aries/blueprint/ext/blueprint-ext.xsd
		  http://cxf.apache.org/blueprint/jaxrs http://cxf.apache.org/schemas/blueprint/jaxrs.xsd
		  http://cxf.apache.org/blueprint/core http://cxf.apache.org/schemas/blueprint/core.xsd
		  http://camel.apache.org/schema/blueprint/cxf http://camel.apache.org/schema/blueprint/cxf/camel-cxf.xsd
		  http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint-2.18.3.xsd
		  http://cxf.apache.org/configuration/beans http://cxf.apache.org/schemas/configuration/cxf-beans.xsd
		  http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0 http://aries.apache.org/schemas/blueprint-cm/blueprint-cm-1.1.0.xsd">

    <cm:property-placeholder id="SEST.placeholder"
                             persistent-id="SEST"/>
    <bean id="loggingFeature" class="org.apache.cxf.feature.LoggingFeature"/>

    <reference id="sysRequirementDBService" timeout="300000"
               availability="optional"
               interface="org.crmf.persistency.mapper.requirement.RequirementServiceInterface"/>

    <reference id="securityPolicyCustom"
               interface="org.crmf.proxy.authnauthz.ShiroSecurityPolicyCustomInterface"/>

    <bean id="sysRequirementProcessor"
          class="org.crmf.requirementimport.processor.SystemRequirementProcessor">
        <property name="requirementService" ref="sysRequirementDBService"></property>
    </bean>

    <bean id="sysRequirementBean"
          class="org.crmf.requirementimport.rest.SystemRequirementRestServer">
        <property name="processor" ref="sysRequirementExcelBean"></property>
    </bean>

    <bean id="sysRequirementExcelBean"
          class="org.crmf.requirementimport.processor.SystemRequirementExcelProcessor">
        <property name="reqProcessor" ref="sysRequirementProcessor"></property>
    </bean>

    <bean id="cors-filter"
          class="org.apache.cxf.rs.security.cors.CrossOriginResourceSharingFilter"/>

    <cxfrs:rsServer id="rsServer1" address="/sysrequirement"
                    serviceClass="org.crmf.requirementimport.rest.SystemRequirementRestServer"
                    loggingSizeLimit="200">
        <cxfrs:providers>
            <ref component-id="cors-filter"/>
        </cxfrs:providers>
        <cxfrs:properties>
            <entry key="attachment-memory-threshold" value="404800"/>
            <entry key="attachment-max-size" value="404800"/>
        </cxfrs:properties>
    </cxfrs:rsServer>

    <bean id="gsonGenericFilter" class="org.apache.camel.component.gson.GsonDataFormat">
        <property name="unmarshalType" value="org.crmf.model.utility.GenericFilter"/>
    </bean>

    <camelContext id="proxyRequirementCamelContext"
                  streamCache="true" trace="true" xmlns="http://camel.apache.org/schema/blueprint">

        <route id="uploadRequirementCXF">
            <from uri="cxfrs:bean:rsServer1"/>
            <log message="=================== Receiving file ================== "
                 loggingLevel="INFO"/>
            <bean ref="sysRequirementBean" method="uploadRequirement"/>
        </route>

        <route id="listRequirementLoadedFile" streamCache="false">
            <from uri="jetty:https://0.0.0.0:9090/sysrequirement/filename/list?enableCORS=true"/>
            <unmarshal ref="gsonGenericFilter"/>
            <log message="listRequirementLoadedFile before ${body}" loggingLevel="INFO"/>

            <setHeader headerName="permission">
                <simple>AssessmentProject:Update</simple>
            </setHeader>
            <policy ref="securityPolicyCustom">
                <bean ref="sysRequirementBean" method="listRequirementLoadedFile"/>
            </policy>
        </route>
    </camelContext>
</blueprint>
